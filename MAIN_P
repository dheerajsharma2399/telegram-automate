# Quick Fix Implementation - main.py Email Generation

**File:** `main.py`  
**Lines:** 115-135 (approximate)  
**Change Type:** Enable automatic email generation  

## Before (Current - Broken):
```python
for job_data in parsed_jobs:
    processed_data = llm_processor.process_job_data(job_data, message["id"])
    
    # Fix: Handle database method compatibility
    try:
        job_id = db.add_processed_job(processed_data)
    except AttributeError:
        # Fallback for compatibility - check alternative method names
        if hasattr(db, 'insert_processed_job'):
            job_id = db.insert_processed_job(processed_data)
        elif hasattr(db, 'save_processed_job'):
            job_id = db.save_processed_job(processed_data)
        else:
            logger.error("No compatible database method found for processed jobs")
            raise Exception("Database method not available")
```

## After (Fixed - Working):
```python
for job_data in parsed_jobs:
    # CRITICAL FIX: Enable email generation during job processing
    processed_data = llm_processor.process_job_data(job_data, message["id"], generate_email=True)
    
    # Enhanced error handling for email generation
    if not processed_data.get('email_body'):
        try:
            logger.info(f"Retrying email generation for job {processed_data.get('job_id', 'unknown')}")
            email_body = llm_processor.generate_email_body(
                job_data, 
                processed_data.get('jd_text', '')
            )
            if email_body:
                processed_data['email_body'] = email_body
                db.update_job_email_body(processed_data['job_id'], email_body)
                logger.info(f"Successfully generated email body for job {processed_data['job_id']}")
        except Exception as e:
            logger.error(f"Email generation failed for job {processed_data.get('job_id', 'unknown')}: {e}")
            # Continue processing without email body - will be picked up by manual generation
    
    # Fix: Handle database method compatibility
    try:
        job_id = db.add_processed_job(processed_data)
    except AttributeError:
        # Fallback for compatibility - check alternative method names
        if hasattr(db, 'insert_processed_job'):
            job_id = db.insert_processed_job(processed_data)
        elif hasattr(db, 'save_processed_job'):
            job_id = db.save_processed_job(processed_data)
        else:
            logger.error("No compatible database method found for processed jobs")
            raise Exception("Database method not available")
```

## Alternative Quick Fix (Minimal Changes):
If you prefer minimal changes, just update line 118:

```python
# Line 118 - change this:
processed_data = llm_processor.process_job_data(job_data, message["id"])

# To this:
processed_data = llm_processor.process_job_data(job_data, message["id"], generate_email=True)
```

## Testing the Fix:
1. Apply the change
2. Restart the bot
3. Send a test message with job listings to Telegram
4. Check database: `SELECT job_id, email_body IS NOT NULL as has_email FROM processed_jobs ORDER BY created_at DESC LIMIT 5;`

## Expected Result:
- New jobs should have email_body populated automatically
- Manual `/generate_emails` command should no longer be needed for new jobs
- Existing jobs without email bodies can be processed using the manual command