version: '3.8'

services:
  telegram-job-scraper:
    build: .
    container_name: telegram-job-scraper
    restart: unless-stopped
    command: honcho start
    env_file: .env
    environment:
      # Connect to the 'postgres-db' container on the dokploy-network
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-db:5432/${POSTGRES_DB:-telegram_bot}

      # App Configuration
      - CONTAINER_TYPE=all
      - PORT=9501
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_PHONE=${TELEGRAM_PHONE}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_GROUP_USERNAMES=${TELEGRAM_GROUP_USERNAMES}
      - AUTHORIZED_USER_IDS=${AUTHORIZED_USER_IDS}
      - ADMIN_USER_ID=${ADMIN_USER_ID}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}
      - OPENROUTER_FALLBACK_MODEL=${OPENROUTER_FALLBACK_MODEL:-openai/gpt-4o-mini}
      - GOOGLE_CREDENTIALS_JSON=${GOOGLE_CREDENTIALS_JSON}
      - SPREADSHEET_ID=${SPREADSHEET_ID}
      - ADDITIONAL_SPREADSHEET_IDS=${ADDITIONAL_SPREADSHEET_IDS}
      - BATCH_SIZE=${BATCH_SIZE:-10}
      - PROCESSING_INTERVAL_MINUTES=${PROCESSING_INTERVAL_MINUTES:-5}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"

      # --- ROUTER: PUBLIC APP (Everything Accessible) ---
      - "traefik.http.routers.job-app.rule=Host(`job.mooh.me`)"
      - "traefik.http.routers.job-app.entrypoints=websecure"
      - "traefik.http.routers.job-app.tls.certresolver=letsencrypt"
      - "traefik.http.routers.job-app.service=job-service"

      # --- HTTP Redirect ---
      - "traefik.http.routers.job-http.rule=Host(`job.mooh.me`)"
      - "traefik.http.routers.job-http.entrypoints=web"
      - "traefik.http.routers.job-http.middlewares=redirect-to-https@file"

      # --- Service Definition ---
      - "traefik.http.services.job-service.loadbalancer.server.port=9501"

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

networks:
  dokploy-network:
    external: true
