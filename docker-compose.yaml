# Simple single-container deployment with external database
version: '3.8'

services:
  telegram-job-scraper:
    image: telegram-job-scraper:latest
    container_name: telegram-job-scraper
    restart: unless-stopped
    command: bash -c "python web_server.py & python main.py & wait"
    environment:
      # Container Configuration
      - CONTAINER_TYPE=all
      - BOT_RUN_MODE=webhook
      
      # Web Server Configuration
      - PORT=9000  # Changed from 8888 to avoid conflict with user's Telegram website
      - FLASK_ENV=production
      - FLASK_DEBUG=0
      
      # External Database Configuration (will be set via environment variable)
      - DATABASE_TYPE=postgresql
      # DATABASE_URL will be provided via environment variable (DATABASE_URL env var)
      
      # All other environment variables
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_PHONE=${TELEGRAM_PHONE}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_GROUP_USERNAMES=${TELEGRAM_GROUP_USERNAMES}
      - AUTHORIZED_USER_IDS=${AUTHORIZED_USER_IDS}
      - ADMIN_USER_ID=${ADMIN_USER_ID}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}
      - OPENROUTER_FALLBACK_MODEL=${OPENROUTER_FALLBACK_MODEL:-openai/gpt-4o-mini}
      - BATCH_SIZE=10
      - PROCESSING_INTERVAL_MINUTES=5
      - MAX_RETRIES=3
      - GOOGLE_CREDENTIALS_JSON=${GOOGLE_CREDENTIALS_JSON}
      - SPREADSHEET_ID=${SPREADSHEET_ID}
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    ports:
      - "9000:9000"  # Changed from 8888 to avoid conflict with user's Telegram website
    networks:
      - telegram_scraper_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

networks:
  telegram_scraper_network:
    driver: bridge